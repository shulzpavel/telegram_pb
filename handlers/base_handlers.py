"""
Base handlers for common functionality
"""
import logging
from aiogram import types, Router
from aiogram.filters import Command

from core.bootstrap import bootstrap
from utils import safe_send_message, get_main_menu
from core.error_handler import safe_handler

logger = logging.getLogger(__name__)

router = Router()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
group_config_service = bootstrap.get_group_config_service()
role_service = bootstrap.get_role_service()


def is_allowed_chat(chat_id: int, topic_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ —á–∞—Ç"""
    logger.info(f"IS_ALLOWED_CHAT: Checking chat_id={chat_id}, topic_id={topic_id}")
    
    try:
        group_config = group_config_service.get_group_config(chat_id, topic_id)
        if group_config and group_config.is_active:
            logger.info(f"IS_ALLOWED_CHAT: Match found for {chat_id}_{topic_id}")
            return True
        else:
            logger.warning(f"IS_ALLOWED_CHAT: No active config found for {chat_id}_{topic_id}")
            return False
    except Exception as e:
        logger.error(f"IS_ALLOWED_CHAT: Error checking config: {e}")
        return False


def is_admin(user: types.User, chat_id: int, topic_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º"""
    logger.info(f"IS_ADMIN: Checking user {user.id} ({user.username}) in chat {chat_id}_{topic_id}")
    
    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Ä–æ–ª–µ–π
    role_can_manage = role_service.can_manage_session(user)
    logger.info(f"IS_ADMIN: Role service result: {role_can_manage}")
    
    if role_can_manage:
        logger.info(f"IS_ADMIN: User {user.id} is admin via role service")
        return True
    
    # Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    group_config_admin = group_config_service.is_admin(chat_id, topic_id, user)
    logger.info(f"IS_ADMIN: Group config service result: {group_config_admin}")
    
    final_result = group_config_admin
    logger.info(f"IS_ADMIN: Final result for user {user.id}: {final_result}")
    return final_result


@router.message(Command("start", "help"))
@safe_handler
async def help_command(msg: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏"""
    if not is_allowed_chat(msg.chat.id, msg.message_thread_id or 0):
        return
    
    if not msg.from_user:
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_is_admin = is_admin(msg.from_user, msg.chat.id, msg.message_thread_id or 0)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
    keyboard = get_main_menu(is_admin=user_is_admin)
    await safe_send_message(
        msg.answer,
        "üéØ **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard,
        parse_mode="Markdown"
    )
