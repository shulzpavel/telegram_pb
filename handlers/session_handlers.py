"""
Session management handlers
"""
import logging
from aiogram import types, Router
from aiogram.filters import Command
from aiogram.fsm.context import FSMContext

from models import PokerStates
from core.bootstrap import bootstrap
from .base_handlers import is_allowed_chat, is_admin
from utils import safe_send_message, get_main_menu

logger = logging.getLogger(__name__)

router = Router()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
session_service = bootstrap.get_session_service()
group_config_service = bootstrap.get_group_config_service()
role_service = bootstrap.get_role_service()




@router.message(Command("leave"))
async def leave_command(msg: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–µ—Å—Å–∏–∏"""
    if not is_allowed_chat(msg.chat.id, msg.message_thread_id or 0):
        return
    
    if not msg.from_user:
        return
    
    chat_id = msg.chat.id
    topic_id = msg.message_thread_id or 0
    
    try:
        participant = session_service.remove_participant(chat_id, topic_id, msg.from_user.id)
        
        if participant:
            await safe_send_message(
                msg.answer,
                f"‚úÖ –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ —Å–µ—Å—Å–∏—é, {participant.full_name.value}!"
            )
        else:
            await safe_send_message(
                msg.answer,
                "‚ùå –í—ã –Ω–µ –±—ã–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —Å–µ—Å—Å–∏–∏."
            )
            
    except Exception as e:
        logger.error(f"Error in leave command: {e}")
        await safe_send_message(
            msg.answer,
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Å–µ—Å—Å–∏–∏."
        )


@router.message(Command("menu"))
async def menu_command(msg: types.Message):
    """–ö–æ–º–∞–Ω–¥–∞ –≤—ã–∑–æ–≤–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    try:
        logger.info(f"MENU_COMMAND: User {msg.from_user.id if msg.from_user else 'None'} in chat {msg.chat.id}, topic {msg.message_thread_id or 0}")
        
        if not is_allowed_chat(msg.chat.id, msg.message_thread_id or 0):
            logger.warning(f"MENU_COMMAND: Chat not allowed for {msg.chat.id}_{msg.message_thread_id or 0}")
            await safe_send_message(
                msg.answer,
                "‚ùå –≠—Ç–æ—Ç —á–∞—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º."
            )
            return
        
        if not msg.from_user:
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        logger.info(f"MENU_COMMAND: About to check admin status for user {msg.from_user.id}")
        user_is_admin = is_admin(msg.from_user, msg.chat.id, msg.message_thread_id or 0)
        logger.info(f"MENU_COMMAND: Admin status result: {user_is_admin}")
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é
        logger.info(f"MENU_COMMAND: About to get main menu with is_admin={user_is_admin}")
        keyboard = get_main_menu(is_admin=user_is_admin)
        logger.info(f"MENU_COMMAND: Got keyboard, about to send message")
        logger.info(f"MENU_COMMAND: Keyboard has {len(keyboard.inline_keyboard)} rows")
        for i, row in enumerate(keyboard.inline_keyboard):
            logger.info(f"MENU_COMMAND: Row {i}: {[btn.text for btn in row]}")
        
        await safe_send_message(
            msg.answer,
            "üéØ **–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é**\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=keyboard,
            parse_mode="Markdown"
        )
        
    except Exception as e:
        logger.error(f"Error in menu command: {e}")
        await safe_send_message(
            msg.answer,
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –º–µ–Ω—é."
        )
