# Анализ тест-кейсов: ожидание vs текущая реализация

Проход по всем 75 кейсам на основе кода (`app/`, `services/voting-service/`).

---

## 1. Подключение участников и состав группы

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **1** | Участник подключается ДО старта сессии | Добавлен в список, участвует во всех задачах. | `join_session` добавляет в `participants`. `all_voters_voted` считает только текущих участников. | ✅ OK |
| **2** | Участник подключается ВО ВРЕМЯ голосования | A/B/C | Вариант **B**: добавляется в `participants`, сразу считается ожидающим голос; может проголосовать до финализации. Кворум динамический. | ⚠️ B |
| **3** | Участник подключается между задачами | Участвует в следующих задачах. | Добавляется в участников, участвует в следующих задачах. | ✅ OK |
| **4** | Участник выходит (leave) ДО старта | Исключён из ожидания голосов. | `leave_session` удаляет из `participants` и из `current_task.votes`. При старте батча учитываются только оставшиеся. | ✅ OK |
| **5** | Участник выходит ВО ВРЕМЯ голосования | Голос аннулируется/фиксируется, кворум пересчитывается. | Голос **аннулируется** (`votes.pop(user_id)`), кворум **динамический** — считается по текущим `participants`. | ✅ OK |
| **6** | Админ удаляет участника во время голосования | Пересчёт кворума, корректный итог. | `kick_user` вызывает `leave_session` — голос удаляется, кворум пересчитывается. | ✅ OK |
| **7** | Админ удаляет участника после голосования | История результатов не ломается. | Результаты хранятся в `task.votes` по `user_id`. В выводе `participant = session.participants.get(user_id)` — если удалён, будет `f"User {user_id}"`. История не затронута. | ✅ OK |
| **8** | Повторное подключение участника | Нет дублей. | `session.participants[user_id] = Participant(...)` — перезапись по ключу. | ✅ OK |
| **9** | Переименование пользователя | Привязка к user_id. | Хранится `Participant(user_id, name, role)`. При join обновляется `name` (перезапись). | ✅ OK |
| **10** | Участник без username (только id/first_name) | Корректное отображение. | Используется `full_name` (first_name + last_name) или `f"User {user_id}"`. | ✅ OK |
| **11** | Бот добавлен в новый чат/тред | Ограничение по chat_id/topic_id. | `SUPPORTED_TOPICS` + `is_supported_thread(chat_id, topic_id)`. В неподдерживаемом чате — отказ. | ✅ OK |
| **12** | Команда вне разрешённого чата/треда | Отказ + понятное сообщение. | **Текущее**: `return` без ответа — пользователь не получает обратной связи. | ❌ Нет сообщения |

---

## 2. Старт/флоу голосования по задаче

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **13** | Старт голосования по одной задаче | Голосование, кнопки Fibonacci. | `start_batch` + `_start_next_task`, кнопки 1,2,3,5,8,13, skip, needs_review. | ✅ OK |
| **14** | Старт без сессии/без участников | Ошибка и подсказка. | Без задач: "❌ Нет задач для голосования." Без участников: старт возможен; при 0 eligible `all_voters_voted` вернёт False (guard). | ⚠️ Старт без участников возможен, но кворум не выполнится |
| **15** | Старт с 1 участником | Кворум 1, итог сразу. | `all_voters_voted`: 1 eligible, 1 vote → True. Итог выводится. | ✅ OK |
| **16** | Нечётное/чётное число участников | Корректный расчёт. | SP = **max(votes)** (get_max_vote), не медиана/среднее. | ⚠️ Политика — максимум |
| **17** | Старт при уже идущем голосовании | Запрет/очередь/авто-завершение. | "ℹ️ Голосование уже запущено." — повторный старт запрещён. | ✅ OK |
| **18** | Перезапуск голосования (re-vote) | Старые голоса очищены. | `needs_review`: задача в конец, `votes.clear()`. Либо новый батч — `start_batch` очищает votes. | ✅ OK |
| **19** | Отмена голосования админом | Закрытие, логирование, переход. | "Сбросить очередь" — reset_queue. Останавливает голосование, удаляет задачи из очереди. | ✅ OK |
| **20** | Пауза/возобновление | Таймер и кнопки. | **Нет** паузы/таймера. Голосование ждёт все голоса или needs_review/reset. | ❌ Не реализовано |

---

## 3. Голосование: голоса, повторы, ошибки

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **21** | Все проголосовали корректно | Итог, SP. | `all_voters_voted` → advance_task → finish_batch → results. | ✅ OK |
| **22** | Голос дважды (разные значения) | A/B/C | **A**: `votes[user_id] = vote_value` перезаписывает. | ✅ OK |
| **23** | Голос дважды (одно значение) | Идемпотентность. | Перезапись тем же значением — ок. | ✅ OK |
| **24** | Кнопка после завершения | Отклонить, сообщить. | `cast_vote`: `current_task` = None → return False. **Нет** `callback.answer()` — пользователь видит "загрузку" без ответа. | ❌ Нет ответа |
| **25** | Бот не может отправить подтверждение | Голос сохранён. | Голос пишется до `callback.answer()`. При ошибке Telegram голос уже в БД. | ✅ OK |
| **26** | Участник теряет интернет и возвращается | Голос принимается до дедлайна. | Нет дедлайна — голос принимается, пока голосование не завершено. | ✅ OK |
| **27** | Участник не проголосовал ("вылетел") | Таймер/кворум. | **Нет таймера**. Ожидание бесконечное без ручного завершения. | ❌ Нет таймера |
| **28** | Голос "?" / "Pass" | По правилам. | Есть `skip` — не учитывается в SP (get_max_vote игнорирует). | ✅ OK |
| **29** | Значение вне Fibonacci (ручной ввод) | Валидация, отказ. | Кнопки только Fibonacci. Ручной ввод **нет** — callback только vote:1..13, skip, needs_review. | ✅ OK (нет ручного ввода) |
| **30** | Смена языка RU/EN | Корректность. | Только RU. | ❌ Только RU |

---

## 4. Завершение, кворум, таймеры

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **31** | Все проголосовали → авто-завершение | Итог сразу. | `all_voters_voted` → advance_task → finish_batch. | ✅ OK |
| **32** | Не все проголосовали, таймер истёк | A/B/C | **Нет таймера**. | ❌ Не реализовано |
| **33** | Не все проголосовали, таймера нет | Ручной finish. | **Нет** кнопки "Завершить досрочно". Только reset_queue (отмена) или needs_review. | ❌ Нет ручного finish |
| **34** | Участник не проголосовал, но удалён/вышел | Пересчёт кворума. | Кворум по текущим `participants`. Leave/kick удаляет — кворум пересчитывается. | ✅ OK |
| **35** | Один "молчун" | Напоминание/таймаут. | Нет напоминаний. | ❌ Не реализовано |
| **36** | Досрочное завершение админом | Итог по проголосовавшим. | **Нет** такой кнопки. | ❌ Не реализовано |
| **37** | Админ завершает дважды | Идемпотентность. | `finish_batch`: `if session.batch_completed: return []`. Не дублирует. | ✅ OK |
| **38** | Рестарт бота в середине голосования | Восстановление. | Сессия в Postgres. После рестарта состояние восстанавливается, сообщение с кнопками остаётся (active_vote_message_id). | ⚠️ Кнопки старые, но данные в БД |
| **39** | Сбой БД в середине | Не потерять / явная ошибка. | При сбое save/load — исключение, ответ пользователю может не дойти. Ретраев на уровне HTTP. | ⚠️ Зависит от инфраструктуры |
| **40** | Сбой отправки итога (rate limit) | Ретраи. | `safe_call` — retry при `TelegramRetryAfter`. | ✅ OK |

---

## 5. Расчёт SP и вывод результата

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **41** | Единогласие | Итог = значение. | get_max_vote — при единогласии max = это значение. | ✅ OK |
| **42** | Разброс (1, 2, 8) | Алгоритм. | **Max** = 8. | ⚠️ Политика — max |
| **43** | Сильный разброс (1, 13, 21) | "Нужно обсуждение". | Нет подсветки — просто max. | ⚠️ Нет |
| **44** | Чётное число, два центральных | Медиана. | Используется max, не медиана. | ⚠️ max |
| **45** | Округление в Fibonacci | По правилам. | Max — целое. Округления нет. | ✅ OK |
| **46** | SP при пропусках | Корректный подсчёт. | `skip` исключается из get_max_vote. | ✅ OK |
| **47** | SP для 0 участников | Отказ. | `all_voters_voted`: `if not eligible_voters: return False`. Финиш не сработает. | ✅ OK |
| **48** | Несколько задач подряд | Отдельные результаты. | Каждая задача в last_batch с собственным SP. | ✅ OK |
| **49** | Длинные сообщения > лимит Telegram | Разбиение. | `MAX_MESSAGE_LENGTH = 4000`, разбиение на части. | ✅ OK |

---

## 6. Пакетный режим

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **50** | Пакет N задач, последовательно | Строгая очередь. | advance_task по одной задаче. | ✅ OK |
| **51** | Отмена пакета в середине | Остановка. | reset_queue — сброс очереди, остановка голосования. | ✅ OK |
| **52** | Пропуск одной задачи | Переход к следующей. | needs_review — задача в конец. "Пропуск" через skip — голос учтён. Прямого skip задачи нет. | ⚠️ Только через needs_review |
| **53** | Добавление задачи во время выполнения | В конец/запрет. | Задачи добавляются через JQL. Очередь append. Можно добавить во время — в конец. | ✅ OK |
| **54** | Дубли в пакете | Разрешить/обнаружить. | Дубли не проверяются. | ⚠️ Не проверяются |
| **55** | Очень длинные summary | Тримминг. | Вывод `task.text` без ограничения. Telegram лимит 4096 — общее разбиение есть. | ⚠️ Отдельные поля не тримятся |

---

## 7. Команды, права, админские сценарии

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **56** | Участник стартует без прав | Отказ. | `can_manage` проверяется для start_voting. | ✅ OK |
| **57** | Админ меняется (передача прав) | Новый админ управляет. | Роли по токенам. Новый /join с ADMIN_TOKEN — получает права. | ✅ OK |
| **58** | Kick в пакетном режиме | Не ломает текущую задачу. | leave_session — пересчёт кворума. Голосование продолжается. | ✅ OK |
| **59** | "Показать статус голосования" | Кто проголосовал/нет. | В сообщении голосования: "✅ Проголосовали", "⏳ Ждём". | ✅ OK |
| **60** | "Показать участников" | Актуальный список. | menu:show_participants — список из session.participants. | ✅ OK |

---

## 8. Telegram-специфика

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **61** | Callback дважды | Идемпотентность. | Голос перезаписывается. callback.answer() идемпотентен. | ✅ OK |
| **62** | Старые inline-кнопки | "Устарело". | Нет проверки "раунда". Старые кнопки голосуют за **текущую** задачу. Могут исказить результат. | ❌ Риск |
| **63** | Бот без прав удалять/пинить | Graceful degradation. | delete_message/edit — при ошибке try/except, fallback (удаление не удалось → новое сообщение). | ✅ OK |
| **64** | Rate limit | Очередь/ретраи. | safe_call — retry при TelegramRetryAfter. | ✅ OK |
| **65** | message_thread_id, голосование не в тот тред | Строго в thread. | topic_id передаётся в notifier. Раньше была ошибка с дублированием — исправлено. | ✅ OK |
| **66** | Бота удалили и добавили обратно | Очистка/новая инициализация. | Сессия в Postgres — сохраняется. При новом добавлении — старые данные. Очистки при "добавлении в чат" нет. | ⚠️ Состояние сохраняется |

---

## 9. Безопасность и устойчивость

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **67** | Инъекции в тексте | Экранирование. | parse_mode="HTML" в ряде мест. participant.name, task.text от Jira — возможно < > &. | ❌ Риск инъекции |
| **68** | Гигантские тексты/файлы | Ограничения. | Ограничений на длину JQL/summary нет. | ⚠️ Нет лимитов |
| **69** | Подмена пользователя | Доверять user_id. | callback.from_user.id, msg.from_user.id — от Telegram. | ✅ OK |
| **70** | Параллельные голосования в разных чатах | Изоляция. | Сессия по (chat_id, topic_id). Разные чаты — отдельные сессии. | ✅ OK |

---

## 10. Краевые кейсы

| # | Кейс | Ожидание | Текущее поведение | Статус |
|---|------|---------|------------------|--------|
| **71** | 0/1/2 участника, потом 10 | Кворум динамический/фиксированный. | **Динамический** — кворум по текущим participants. | ✅ OK |
| **72** | Голос в последнюю секунду таймера | Детерминированно. | Таймера нет. | — |
| **73** | Админ завершает + последний голос одновременно | Нет двойного итога. | Ручного finish нет. Race при all_voters_voted + advance_task — возможна при высокой конкуренции. | ⚠️ Возможна гонка |
| **74** | Часовой пояс/время | Monotonic. | current_batch_started_at для is_voting_active. Таймера нет. | — |
| **75** | Рестарт при подсчёте итогов | Не дублировать вывод. | finish_batch: `if session.batch_completed: return []`. Идемпотентно. | ✅ OK |

---

## Рекомендуемый эталон (из запроса)

| Правило | Текущее |
|---------|---------|
| Состав участников фиксируется на старте задачи | ❌ **Нет** — состав динамический |
| Новый участник во время голосования → со следующей задачи | ❌ **Нет** — включается сразу (вариант B) |
| При таймауте → по проголосовавшим, непришедшие помечаются | ❌ **Нет таймаута** |
| Повторный голос → перезапись до завершения | ✅ **Да** |

---

## Защита от дублирования (реализовано)

- **add_tasks** — `existing_keys` включает `history` — задачи из прошлых батчей не добавляются повторно  
- **handle_vote** — lock `vote_advance` при переходе к следующей задаче — защита от двойного advance при одновременных голосах  
- **voting-service /tasks/add** — проверка дубликатов по `jira_key` в queue, last_batch, history  
- **#62** — Проверка актуальности кнопок по `active_vote_message_id`

## Приоритетные исправления (не реализовано)

1. **#12** — Сообщение при отказе в неподдерживаемом чате  
2. **#24** — Ответ на голос после завершения ("Голосование закрыто")  
3. **#67** — Экранирование HTML в пользовательском контенте  
4. **#33, #36** — Кнопка "Завершить досрочно" для админов  
5. **#27, #32, #35** — Таймер голосования (опционально)
